
# Artificial Intelligence Nanodegree

## Convolutional Neural Networks

## Project: Write an Algorithm for a Dog Identification App 

---

In this notebook, some template code has already been provided for you, and you will need to implement additional functionality to successfully complete this project. You will not need to modify the included code beyond what is requested. Sections that begin with **'(IMPLEMENTATION)'** in the header indicate that the following block of code will require additional functionality which you must provide. Instructions will be provided for each section, and the specifics of the implementation are marked in the code block with a 'TODO' statement. Please be sure to read the instructions carefully! 

> **Note**: Once you have completed all of the code implementations, you need to finalize your work by exporting the iPython Notebook as an HTML document. Before exporting the notebook to html, all of the code cells need to have been run so that reviewers can see the final implementation and output. You can then export the notebook by using the menu above and navigating to  \n",
    "**File -> Download as -> HTML (.html)**. Include the finished document along with this notebook as your submission.

In addition to implementing code, there will be questions that you must answer which relate to the project and your implementation. Each section where you will answer a question is preceded by a **'Question X'** header. Carefully read each question and provide thorough answers in the following text boxes that begin with **'Answer:'**. Your project submission will be evaluated based on your answers to each of the questions and the implementation you provide.

>**Note:** Code and Markdown cells can be executed using the **Shift + Enter** keyboard shortcut.  Markdown cells can be edited by double-clicking the cell to enter edit mode.

The rubric contains _optional_ "Stand Out Suggestions" for enhancing the project beyond the minimum requirements. If you decide to pursue the "Stand Out Suggestions", you should include the code in this IPython notebook.



---
### Why We're Here 

In this notebook, you will make the first steps towards developing an algorithm that could be used as part of a mobile or web app.  At the end of this project, your code will accept any user-supplied image as input.  If a dog is detected in the image, it will provide an estimate of the dog's breed.  If a human is detected, it will provide an estimate of the dog breed that is most resembling.  The image below displays potential sample output of your finished project (... but we expect that each student's algorithm will behave differently!). 

![Sample Dog Output](images/sample_dog_output.png)

In this real-world setting, you will need to piece together a series of models to perform different tasks; for instance, the algorithm that detects humans in an image will be different from the CNN that infers dog breed.  There are many points of possible failure, and no perfect algorithm exists.  Your imperfect solution will nonetheless create a fun user experience!

### The Road Ahead

We break the notebook into separate steps.  Feel free to use the links below to navigate the notebook.

* [Step 0](#step0): Import Datasets
* [Step 1](#step1): Detect Humans
* [Step 2](#step2): Detect Dogs
* [Step 3](#step3): Create a CNN to Classify Dog Breeds (from Scratch)
* [Step 4](#step4): Use a CNN to Classify Dog Breeds (using Transfer Learning)
* [Step 5](#step5): Create a CNN to Classify Dog Breeds (using Transfer Learning)
* [Step 6](#step6): Write your Algorithm
* [Step 7](#step7): Test Your Algorithm

---
<a id='step0'></a>
## Step 0: Import Datasets

### Import Dog Dataset

In the code cell below, we import a dataset of dog images.  We populate a few variables through the use of the `load_files` function from the scikit-learn library:
- `train_files`, `valid_files`, `test_files` - numpy arrays containing file paths to images
- `train_targets`, `valid_targets`, `test_targets` - numpy arrays containing onehot-encoded classification labels 
- `dog_names` - list of string-valued dog breed names for translating labels


```python
from sklearn.datasets import load_files       
from keras.utils import np_utils
import numpy as np
from glob import glob

# define function to load train, test, and validation datasets
def load_dataset(path):
    data = load_files(path)
    dog_files = np.array(data['filenames'])
    dog_targets = np_utils.to_categorical(np.array(data['target']), 133)
    return dog_files, dog_targets

# load train, test, and validation datasets
train_files, train_targets = load_dataset('dogImages/train')
valid_files, valid_targets = load_dataset('dogImages/valid')
test_files, test_targets = load_dataset('dogImages/test')

# load list of dog names
dog_names = [item[20:-1] for item in sorted(glob("dogImages/train/*/"))]

# print statistics about the dataset
print('There are %d total dog categories.' % len(dog_names))
print('There are %s total dog images.\n' % len(np.hstack([train_files, valid_files, test_files])))
print('There are %d training dog images.' % len(train_files))
print('There are %d validation dog images.' % len(valid_files))
print('There are %d test dog images.'% len(test_files))
```

    Using TensorFlow backend.
    

    There are 133 total dog categories.
    There are 8351 total dog images.
    
    There are 6680 training dog images.
    There are 835 validation dog images.
    There are 836 test dog images.
    

### Import Human Dataset

In the code cell below, we import a dataset of human images, where the file paths are stored in the numpy array `human_files`.


```python
import random
random.seed(8675309)

# load filenames in shuffled human dataset
human_files = np.array(glob("lfw/*/*"))
random.shuffle(human_files)

# print statistics about the dataset
print('There are %d total human images.' % len(human_files))
```

    There are 13233 total human images.
    

---
<a id='step1'></a>
## Step 1: Detect Humans

We use OpenCV's implementation of [Haar feature-based cascade classifiers](http://docs.opencv.org/trunk/d7/d8b/tutorial_py_face_detection.html) to detect human faces in images.  OpenCV provides many pre-trained face detectors, stored as XML files on [github](https://github.com/opencv/opencv/tree/master/data/haarcascades).  We have downloaded one of these detectors and stored it in the `haarcascades` directory.

In the next code cell, we demonstrate how to use this detector to find human faces in a sample image.


```python
import cv2                
import matplotlib.pyplot as plt                        
%matplotlib inline                               

# extract pre-trained face detector
face_cascade = cv2.CascadeClassifier('haarcascades/haarcascade_frontalface_alt.xml')

# load color (BGR) image
img = cv2.imread(human_files[3])
# convert BGR image to grayscale
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

# find faces in image
faces = face_cascade.detectMultiScale(gray)

# print number of faces detected in the image
print('Number of faces detected:', len(faces))

# get bounding box for each detected face
for (x,y,w,h) in faces:
    # add bounding box to color image
    cv2.rectangle(img,(x,y),(x+w,y+h),(255,0,0),2)
    
# convert BGR image to RGB for plotting
cv_rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)

# display the image, along with bounding box
plt.imshow(cv_rgb)
plt.show()
```

    Number of faces detected: 1
    


![png](output_5_1.png)


Before using any of the face detectors, it is standard procedure to convert the images to grayscale.  The `detectMultiScale` function executes the classifier stored in `face_cascade` and takes the grayscale image as a parameter.  

In the above code, `faces` is a numpy array of detected faces, where each row corresponds to a detected face.  Each detected face is a 1D array with four entries that specifies the bounding box of the detected face.  The first two entries in the array (extracted in the above code as `x` and `y`) specify the horizontal and vertical positions of the top left corner of the bounding box.  The last two entries in the array (extracted here as `w` and `h`) specify the width and height of the box.

### Write a Human Face Detector

We can use this procedure to write a function that returns `True` if a human face is detected in an image and `False` otherwise.  This function, aptly named `face_detector`, takes a string-valued file path to an image as input and appears in the code block below.


```python
# returns "True" if face is detected in image stored at img_path
def face_detector(img_path):
    img = cv2.imread(img_path)
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    faces = face_cascade.detectMultiScale(gray)
    return len(faces) > 0
```

### (IMPLEMENTATION) Assess the Human Face Detector

__Question 1:__ Use the code cell below to test the performance of the `face_detector` function.  
- What percentage of the first 100 images in `human_files` have a detected human face?  
- What percentage of the first 100 images in `dog_files` have a detected human face? 

Ideally, we would like 100% of human images with a detected face and 0% of dog images with a detected face.  You will see that our algorithm falls short of this goal, but still gives acceptable performance.  We extract the file paths for the first 100 images from each of the datasets and store them in the numpy arrays `human_files_short` and `dog_files_short`.

__Answer:__ 


```python
human_files_short = human_files[:100]
dog_files_short = train_files[:100]
# Do NOT modify the code above this line.

## TODO: Test the performance of the face_detector algorithm
def test_performance(dataset):
    size = len(dataset)
    c = 0;
    for i in range(size):
        if face_detector(dataset[i]) == True:
            c += 1
    return c / size * 100

print('The first 100 images in human_files have %d %% detected faces' % test_performance(human_files_short))
print('The first 100 images in dog_files have %d %% detected faces' % test_performance(dog_files_short))
## on the images in human_files_short and dog_files_short.
```

    The first 100 images in human_files have 99 % detected faces
    The first 100 images in dog_files have 11 % detected faces
    

__Question 2:__ This algorithmic choice necessitates that we communicate to the user that we accept human images only when they provide a clear view of a face (otherwise, we risk having unneccessarily frustrated users!). In your opinion, is this a reasonable expectation to pose on the user? If not, can you think of a way to detect humans in images that does not necessitate an image with a clearly presented face?

__Answer:__

We suggest the face detector from OpenCV as a potential way to detect human images in your algorithm, but you are free to explore other approaches, especially approaches that make use of deep learning :).  Please use the code cell below to design and test your own face detection algorithm.  If you decide to pursue this _optional_ task, report performance on each of the datasets.


```python
## (Optional) TODO: Report the performance of another  
## face detection algorithm on the LFW dataset
### Feel free to use as many code cells as needed.
```

---
<a id='step2'></a>
## Step 2: Detect Dogs

In this section, we use a pre-trained [ResNet-50](http://ethereon.github.io/netscope/#/gist/db945b393d40bfa26006) model to detect dogs in images.  Our first line of code downloads the ResNet-50 model, along with weights that have been trained on [ImageNet](http://www.image-net.org/), a very large, very popular dataset used for image classification and other vision tasks.  ImageNet contains over 10 million URLs, each linking to an image containing an object from one of [1000 categories](https://gist.github.com/yrevar/942d3a0ac09ec9e5eb3a).  Given an image, this pre-trained ResNet-50 model returns a prediction (derived from the available categories in ImageNet) for the object that is contained in the image.


```python
from keras.applications.resnet50 import ResNet50

# define ResNet50 model
ResNet50_model = ResNet50(weights='imagenet')
```

### Pre-process the Data

When using TensorFlow as backend, Keras CNNs require a 4D array (which we'll also refer to as a 4D tensor) as input, with shape

$$
(\text{nb_samples}, \text{rows}, \text{columns}, \text{channels}),
$$

where `nb_samples` corresponds to the total number of images (or samples), and `rows`, `columns`, and `channels` correspond to the number of rows, columns, and channels for each image, respectively.  

The `path_to_tensor` function below takes a string-valued file path to a color image as input and returns a 4D tensor suitable for supplying to a Keras CNN.  The function first loads the image and resizes it to a square image that is $224 \times 224$ pixels.  Next, the image is converted to an array, which is then resized to a 4D tensor.  In this case, since we are working with color images, each image has three channels.  Likewise, since we are processing a single image (or sample), the returned tensor will always have shape

$$
(1, 224, 224, 3).
$$

The `paths_to_tensor` function takes a numpy array of string-valued image paths as input and returns a 4D tensor with shape 

$$
(\text{nb_samples}, 224, 224, 3).
$$

Here, `nb_samples` is the number of samples, or number of images, in the supplied array of image paths.  It is best to think of `nb_samples` as the number of 3D tensors (where each 3D tensor corresponds to a different image) in your dataset!


```python
from keras.preprocessing import image                  
# from tqdm import tqdm

def path_to_tensor(img_path):
    # loads RGB image as PIL.Image.Image type
    img = image.load_img(img_path, target_size=(224, 224))
    # convert PIL.Image.Image type to 3D tensor with shape (224, 224, 3)
    x = image.img_to_array(img)
    # convert 3D tensor to 4D tensor with shape (1, 224, 224, 3) and return 4D tensor
    return np.expand_dims(x, axis=0)

# def paths_to_tensor(img_paths):
#     list_of_tensors = [path_to_tensor(img_path) for img_path in tqdm(img_paths)]
#     return np.vstack(list_of_tensors)

def paths_to_tensor(img_paths):
    list_of_tensors = [path_to_tensor(img_path) for img_path in img_paths]
    return np.vstack(list_of_tensors)
```

### Making Predictions with ResNet-50

Getting the 4D tensor ready for ResNet-50, and for any other pre-trained model in Keras, requires some additional processing.  First, the RGB image is converted to BGR by reordering the channels.  All pre-trained models have the additional normalization step that the mean pixel (expressed in RGB as $[103.939, 116.779, 123.68]$ and calculated from all pixels in all images in ImageNet) must be subtracted from every pixel in each image.  This is implemented in the imported function `preprocess_input`.  If you're curious, you can check the code for `preprocess_input` [here](https://github.com/fchollet/keras/blob/master/keras/applications/imagenet_utils.py).

Now that we have a way to format our image for supplying to ResNet-50, we are now ready to use the model to extract the predictions.  This is accomplished with the `predict` method, which returns an array whose $i$-th entry is the model's predicted probability that the image belongs to the $i$-th ImageNet category.  This is implemented in the `ResNet50_predict_labels` function below.

By taking the argmax of the predicted probability vector, we obtain an integer corresponding to the model's predicted object class, which we can identify with an object category through the use of this [dictionary](https://gist.github.com/yrevar/942d3a0ac09ec9e5eb3a). 


```python
from keras.applications.resnet50 import preprocess_input, decode_predictions

def ResNet50_predict_labels(img_path):
    # returns prediction vector for image located at img_path
    img = preprocess_input(path_to_tensor(img_path))
    return np.argmax(ResNet50_model.predict(img))
```

### Write a Dog Detector

While looking at the [dictionary](https://gist.github.com/yrevar/942d3a0ac09ec9e5eb3a), you will notice that the categories corresponding to dogs appear in an uninterrupted sequence and correspond to dictionary keys 151-268, inclusive, to include all categories from `'Chihuahua'` to `'Mexican hairless'`.  Thus, in order to check to see if an image is predicted to contain a dog by the pre-trained ResNet-50 model, we need only check if the `ResNet50_predict_labels` function above returns a value between 151 and 268 (inclusive).

We use these ideas to complete the `dog_detector` function below, which returns `True` if a dog is detected in an image (and `False` if not).


```python
### returns "True" if a dog is detected in the image stored at img_path
def dog_detector(img_path):
    prediction = ResNet50_predict_labels(img_path)
    return ((prediction <= 268) & (prediction >= 151)) 
```

### (IMPLEMENTATION) Assess the Dog Detector

__Question 3:__ Use the code cell below to test the performance of your `dog_detector` function.  
- What percentage of the images in `human_files_short` have a detected dog?  
- What percentage of the images in `dog_files_short` have a detected dog?

__Answer:__ 


```python
### TODO: Test the performance of the dog_detector function
### on the images in human_files_short and dog_files_short.

def test_performance_dog_detector(dataset):
    size = len(dataset)
    c = 0;
    for i in range(size):
        if dog_detector(dataset[i]) == True:
            c += 1
    return c / size * 100

print('The first 100 images in human_files have %d %% detected dog' % test_performance_dog_detector(human_files_short))
print('The first 100 images in dog_files have %d %% detected dog' % test_performance_dog_detector(dog_files_short))

```

    The first 100 images in human_files have 1 % detected dog
    The first 100 images in dog_files have 100 % detected dog
    

---
<a id='step3'></a>
## Step 3: Create a CNN to Classify Dog Breeds (from Scratch)

Now that we have functions for detecting humans and dogs in images, we need a way to predict breed from images.  In this step, you will create a CNN that classifies dog breeds.  You must create your CNN _from scratch_ (so, you can't use transfer learning _yet_!), and you must attain a test accuracy of at least 1%.  In Step 5 of this notebook, you will have the opportunity to use transfer learning to create a CNN that attains greatly improved accuracy.

Be careful with adding too many trainable layers!  More parameters means longer training, which means you are more likely to need a GPU to accelerate the training process.  Thankfully, Keras provides a handy estimate of the time that each epoch is likely to take; you can extrapolate this estimate to figure out how long it will take for your algorithm to train. 

We mention that the task of assigning breed to dogs from images is considered exceptionally challenging.  To see why, consider that *even a human* would have great difficulty in distinguishing between a Brittany and a Welsh Springer Spaniel.  

Brittany | Welsh Springer Spaniel
- | - 
<img src="images/Brittany_02625.jpg" width="100"> | <img src="images/Welsh_springer_spaniel_08203.jpg" width="200">

It is not difficult to find other dog breed pairs with minimal inter-class variation (for instance, Curly-Coated Retrievers and American Water Spaniels).  

Curly-Coated Retriever | American Water Spaniel
- | -
<img src="images/Curly-coated_retriever_03896.jpg" width="200"> | <img src="images/American_water_spaniel_00648.jpg" width="200">


Likewise, recall that labradors come in yellow, chocolate, and black.  Your vision-based algorithm will have to conquer this high intra-class variation to determine how to classify all of these different shades as the same breed.  

Yellow Labrador | Chocolate Labrador | Black Labrador
- | -
<img src="images/Labrador_retriever_06457.jpg" width="150"> | <img src="images/Labrador_retriever_06455.jpg" width="240"> | <img src="images/Labrador_retriever_06449.jpg" width="220">

We also mention that random chance presents an exceptionally low bar: setting aside the fact that the classes are slightly imabalanced, a random guess will provide a correct answer roughly 1 in 133 times, which corresponds to an accuracy of less than 1%.  

Remember that the practice is far ahead of the theory in deep learning.  Experiment with many different architectures, and trust your intuition.  And, of course, have fun! 

### Pre-process the Data

We rescale the images by dividing every pixel in every image by 255.


```python
from PIL import ImageFile                            
ImageFile.LOAD_TRUNCATED_IMAGES = True                 

# pre-process the data for Keras
train_tensors = paths_to_tensor(train_files).astype('float32')/255
valid_tensors = paths_to_tensor(valid_files).astype('float32')/255
test_tensors = paths_to_tensor(test_files).astype('float32')/255
```

### (IMPLEMENTATION) Model Architecture

Create a CNN to classify dog breed.  At the end of your code cell block, summarize the layers of your model by executing the line:
    
        model.summary()

We have imported some Python modules to get you started, but feel free to import as many modules as you need.  If you end up getting stuck, here's a hint that specifies a model that trains relatively fast on CPU and attains >1% test accuracy in 5 epochs:

![Sample CNN](images/sample_cnn.png)
           
__Question 4:__ Outline the steps you took to get to your final CNN architecture and your reasoning at each step.  If you chose to use the hinted architecture above, describe why you think that CNN architecture should work well for the image classification task.

__Answer:__ 

At first I started with 5 epochs and Loss plot callback function written below to get some intuition of how changing parameters affected the accuracy. I wish that I could try with more epochs but I didn't want to spend too much time training. 

I started with the architecture above but with **[2, 4, 8] filters** and no global average pooling. The results were poor, as I expected but I thought that starting with a low amount of trainable parameters would be more efficient. Having no experience in deep learning, I decided to take that approach to build some intuition. 

I added a **hidden layer with 256 nodes** to the MLP at the end of the CNN as a way to add more complexity to the network, thinking that adding a layer would  enable it to fit to a wider range of patterns and since it was its first hidden layer, i didn't think that it would overfit. However, this lead to a model with too many trainable parameters for my computer to train in a reasonable amount of time, **3,203,331 parameters**. I then decided to add a global average pooling layer to reduce the amount of trainable parameters to just **71,331**. I trained the model and it lead to an accuracy of **1.67%** after 5 epochs.

The next step was to **increase the number of filters** and see how the model behaved, I first started with **[16, 32, 64] filters** as described above which lead to **109,677** parameters. The idea was that more filters would allow the network to see a wider range of patterns and by adding more filters for the deeper layer that should see more complex shapes would benefit more from the added amount of filters. This approach led to an accuracy of **2.2727%** which was a good improvement over the previous approach. I then decided to further increase the **number of filters to [64, 128, 256]** for **360,189** trainable parameters and an accuracy of **2.6316%**. Less of an improvement jump that previously seen.

Finally, plotting the training losses and validation losses live while **increasing the number of epochs by 5** seemed to lead to significant improvements but settled at **50 epochs** due to the enormous increase in training time. The final accuracy achieved was **16.7%** and **14.8%** as the model was ran twice.

In conclusion, I plan to further experiment with hyperparameters to build more conclusive intuitions but it would have to be done over time as repeated training is very time consuming. 

PS: I needed to rerun the whole notebook because tqdm was conflicting with the keras progress bars and changed to 5 epochs because I didn't want to go through the whole hour of training again. However, this was the result after 50 epochs:

**Image taken once training was complete:**

![50epochs](test_images/50epochs.JPG)

`Test accuracy: 14.8325%`

**Image taken during training:**

![](test_images/50epochs_training.jpeg)


```python
print('Images:\n')
print('The shape of train_tensors: {}'.format(train_tensors.shape))
print('The shape of valid_tensors: {}'.format(valid_tensors.shape))
print('The shape of test_tensors: {}\n'.format(test_tensors.shape))

print('Labels:\n')
print('The shape of train_targets: {}'.format(train_targets.shape))
print('The shape of valid_targets: {}'.format(valid_targets.shape))
print('The shape of test_targets: {}'.format(test_targets.shape))

```

    Images:
    
    The shape of train_tensors: (6680, 224, 224, 3)
    The shape of valid_tensors: (835, 224, 224, 3)
    The shape of test_tensors: (836, 224, 224, 3)
    
    Labels:
    
    The shape of train_targets: (6680, 133)
    The shape of valid_targets: (835, 133)
    The shape of test_targets: (836, 133)
    


```python
import keras
from IPython.display import clear_output
# https://gist.github.com/stared/dfb4dfaf6d9a8501cd1cc8b8cb806d2e

# Below is live plot
class PlotLosses(keras.callbacks.Callback):
    def on_train_begin(self, logs={}):
        self.i = 0
        self.x = []
        self.losses = []
        self.val_losses = []
        
        self.fig = plt.figure()
        
        self.logs = []

    def on_epoch_end(self, epoch, logs={}):
        
        self.logs.append(logs)
        self.x.append(self.i)
        self.losses.append(logs.get('loss'))
        self.val_losses.append(logs.get('val_loss'))
        self.i += 1
        
        plt.close('all')
        plt.plot(self.x, self.losses, label="loss")
        plt.plot(self.x, self.val_losses, label="val_loss")
        plt.legend()
        plt.xlabel('Epochs')
        plt.ylabel('Losses')
        plt.show();
        
# Below is plotting after the training is done
def plot_loss(model):
    loss = model.history['loss']
    val_loss = model.history['val_loss']
    plt.plot(loss, label="loss")
    plt.plot(val_loss, label="val_loss")
    plt.legend()
    plt.xlabel('Epochs')
    plt.ylabel('Losses')
    plt.show();
```


```python
from keras.layers import Conv2D, MaxPooling2D, GlobalAveragePooling2D
from keras.layers import Dropout, Flatten, Dense
from keras.models import Sequential

model = Sequential()

model.add(Conv2D(filters=64, kernel_size=2, padding='same', activation='relu', input_shape=(224, 224, 3)))
model.add(MaxPooling2D(pool_size=2))
model.add(Conv2D(filters=128, kernel_size=2, padding='same', activation='relu'))
model.add(MaxPooling2D(pool_size=2))
model.add(Conv2D(filters=256, kernel_size=2, padding='same', activation='relu'))
model.add(GlobalAveragePooling2D())
# model.add(MaxPooling2D(pool_size=2))
# model.add(Flatten())
model.add(Dropout(0.3))
model.add(Dense(256, activation='relu'))
model.add(Dropout(0.4))
model.add(Dense(133, activation='softmax'))

model.summary()
```

    _________________________________________________________________
    Layer (type)                 Output Shape              Param #   
    =================================================================
    conv2d_1 (Conv2D)            (None, 224, 224, 64)      832       
    _________________________________________________________________
    max_pooling2d_2 (MaxPooling2 (None, 112, 112, 64)      0         
    _________________________________________________________________
    conv2d_2 (Conv2D)            (None, 112, 112, 128)     32896     
    _________________________________________________________________
    max_pooling2d_3 (MaxPooling2 (None, 56, 56, 128)       0         
    _________________________________________________________________
    conv2d_3 (Conv2D)            (None, 56, 56, 256)       131328    
    _________________________________________________________________
    global_average_pooling2d_1 ( (None, 256)               0         
    _________________________________________________________________
    dropout_1 (Dropout)          (None, 256)               0         
    _________________________________________________________________
    dense_1 (Dense)              (None, 256)               65792     
    _________________________________________________________________
    dropout_2 (Dropout)          (None, 256)               0         
    _________________________________________________________________
    dense_2 (Dense)              (None, 133)               34181     
    =================================================================
    Total params: 265,029.0
    Trainable params: 265,029.0
    Non-trainable params: 0.0
    _________________________________________________________________
    

### Compile the Model


```python
model.compile(optimizer='rmsprop', loss='categorical_crossentropy', metrics=['accuracy'])
```

### (IMPLEMENTATION) Train the Model

Train your model in the code cell below.  Use model checkpointing to save the model that attains the best validation loss.


You are welcome to [augment the training data](https://blog.keras.io/building-powerful-image-classification-models-using-very-little-data.html), but this is not a requirement. 


```python
from keras.callbacks import ModelCheckpoint
# from keras_tqdm import TQDMNotebookCallback

### TODO: specify the number of epochs that you would like to use to train the model.

epochs = 5

### Do NOT modify the code below this line.

checkpointer = ModelCheckpoint(filepath='saved_models/weights.best.from_scratch.hdf5', 
                               verbose=1, save_best_only=True)

model.fit(train_tensors, train_targets, 
          validation_data=(valid_tensors, valid_targets),
          epochs=epochs, batch_size=20, callbacks=[checkpointer], verbose=1)
```

    Train on 6680 samples, validate on 835 samples
    Epoch 1/5
    6660/6680 [============================>.] - ETA: 0s - loss: 4.8849 - acc: 0.0078      Epoch 00000: val_loss improved from inf to 4.87007, saving model to saved_models/weights.best.from_scratch.hdf5
    6680/6680 [==============================] - 80s - loss: 4.8848 - acc: 0.0078 - val_loss: 4.8701 - val_acc: 0.0108
    Epoch 2/5
    6660/6680 [============================>.] - ETA: 0s - loss: 4.8519 - acc: 0.0141 Epoch 00001: val_loss improved from 4.87007 to 4.81380, saving model to saved_models/weights.best.from_scratch.hdf5
    6680/6680 [==============================] - 78s - loss: 4.8521 - acc: 0.0141 - val_loss: 4.8138 - val_acc: 0.0180
    Epoch 3/5
    6660/6680 [============================>.] - ETA: 0s - loss: 4.7786 - acc: 0.0167     Epoch 00002: val_loss improved from 4.81380 to 4.75793, saving model to saved_models/weights.best.from_scratch.hdf5
    6680/6680 [==============================] - 78s - loss: 4.7785 - acc: 0.0168 - val_loss: 4.7579 - val_acc: 0.0204
    Epoch 4/5
    6660/6680 [============================>.] - ETA: 0s - loss: 4.7356 - acc: 0.0182     Epoch 00003: val_loss improved from 4.75793 to 4.72730, saving model to saved_models/weights.best.from_scratch.hdf5
    6680/6680 [==============================] - 78s - loss: 4.7363 - acc: 0.0181 - val_loss: 4.7273 - val_acc: 0.0204
    Epoch 5/5
    6660/6680 [============================>.] - ETA: 0s - loss: 4.7018 - acc: 0.0209     Epoch 00004: val_loss improved from 4.72730 to 4.68576, saving model to saved_models/weights.best.from_scratch.hdf5
    6680/6680 [==============================] - 78s - loss: 4.7014 - acc: 0.0208 - val_loss: 4.6858 - val_acc: 0.0263
    




    <keras.callbacks.History at 0x21963aa2e80>



### Load the Model with the Best Validation Loss


```python
model.load_weights('saved_models/weights.best.from_scratch.hdf5')
```

### Test the Model

Try out your model on the test dataset of dog images.  Ensure that your test accuracy is greater than 1%.


```python
# get index of predicted dog breed for each image in test set
dog_breed_predictions = [np.argmax(model.predict(np.expand_dims(tensor, axis=0))) for tensor in test_tensors]

# report test accuracy
test_accuracy = 100*np.sum(np.array(dog_breed_predictions)==np.argmax(test_targets, axis=1))/len(dog_breed_predictions)
print('Test accuracy: %.4f%%' % test_accuracy)
```

    Test accuracy: 2.2727%
    

---
<a id='step4'></a>
## Step 4: Use a CNN to Classify Dog Breeds

To reduce training time without sacrificing accuracy, we show you how to train a CNN using transfer learning.  In the following step, you will get a chance to use transfer learning to train your own CNN.

### Obtain Bottleneck Features


```python
bottleneck_features = np.load('bottleneck_features/DogVGG16Data.npz')
train_VGG16 = bottleneck_features['train']
valid_VGG16 = bottleneck_features['valid']
test_VGG16 = bottleneck_features['test']
```

### Model Architecture

The model uses the the pre-trained VGG-16 model as a fixed feature extractor, where the last convolutional output of VGG-16 is fed as input to our model.  We only add a global average pooling layer and a fully connected layer, where the latter contains one node for each dog category and is equipped with a softmax.


```python
VGG16_model = Sequential()
VGG16_model.add(GlobalAveragePooling2D(input_shape=train_VGG16.shape[1:]))
VGG16_model.add(Dense(133, activation='softmax'))

VGG16_model.summary()
```

    _________________________________________________________________
    Layer (type)                 Output Shape              Param #   
    =================================================================
    global_average_pooling2d_2 ( (None, 512)               0         
    _________________________________________________________________
    dense_3 (Dense)              (None, 133)               68229     
    =================================================================
    Total params: 68,229.0
    Trainable params: 68,229.0
    Non-trainable params: 0.0
    _________________________________________________________________
    

### Compile the Model


```python
VGG16_model.compile(loss='categorical_crossentropy', optimizer='rmsprop', metrics=['accuracy'])
```

### Train the Model


```python
from keras.callbacks import ModelCheckpoint
# from keras_tqdm import TQDMNotebookCallback
checkpointer = ModelCheckpoint(filepath='saved_models/weights.best.VGG16.hdf5', 
                               verbose=1, save_best_only=True)

VGG16plot = VGG16_model.fit(train_VGG16, train_targets, 
          validation_data=(valid_VGG16, valid_targets),
          epochs=20, batch_size=20, callbacks=[checkpointer], verbose=1)
```

    Train on 6680 samples, validate on 835 samples
    Epoch 1/20
    6540/6680 [============================>.] - ETA: 0s - loss: 12.4304 - acc: 0.1139      Epoch 00000: val_loss improved from inf to 10.52455, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 3s - loss: 12.3941 - acc: 0.1160 - val_loss: 10.5245 - val_acc: 0.2060
    Epoch 2/20
    6580/6680 [============================>.] - ETA: 0s - loss: 9.6437 - acc: 0.2976 Epoch 00001: val_loss improved from 10.52455 to 9.56475, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 9.6412 - acc: 0.2976 - val_loss: 9.5648 - val_acc: 0.3006
    Epoch 3/20
    6600/6680 [============================>.] - ETA: 0s - loss: 9.0162 - acc: 0.3724Epoch 00002: val_loss improved from 9.56475 to 9.26076, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 9.0260 - acc: 0.3726 - val_loss: 9.2608 - val_acc: 0.3497
    Epoch 4/20
    6660/6680 [============================>.] - ETA: 0s - loss: 8.7876 - acc: 0.4078Epoch 00003: val_loss improved from 9.26076 to 9.16592, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 8.7855 - acc: 0.4081 - val_loss: 9.1659 - val_acc: 0.3605
    Epoch 5/20
    6620/6680 [============================>.] - ETA: 0s - loss: 8.6862 - acc: 0.4310 Epoch 00004: val_loss improved from 9.16592 to 9.09376, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 3s - loss: 8.6940 - acc: 0.4304 - val_loss: 9.0938 - val_acc: 0.3665
    Epoch 6/20
    6620/6680 [============================>.] - ETA: 0s - loss: 8.5852 - acc: 0.4440 Epoch 00005: val_loss improved from 9.09376 to 9.05604, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 3s - loss: 8.5812 - acc: 0.4443 - val_loss: 9.0560 - val_acc: 0.3701
    Epoch 7/20
    6600/6680 [============================>.] - ETA: 0s - loss: 8.4506 - acc: 0.4521Epoch 00006: val_loss improved from 9.05604 to 8.93110, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 3s - loss: 8.4605 - acc: 0.4518 - val_loss: 8.9311 - val_acc: 0.3844
    Epoch 8/20
    6620/6680 [============================>.] - ETA: 0s - loss: 8.3798 - acc: 0.4618Epoch 00007: val_loss improved from 8.93110 to 8.92260, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 3s - loss: 8.3870 - acc: 0.4612 - val_loss: 8.9226 - val_acc: 0.3749
    Epoch 9/20
    6660/6680 [============================>.] - ETA: 0s - loss: 8.3207 - acc: 0.4706Epoch 00008: val_loss improved from 8.92260 to 8.87180, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 3s - loss: 8.3176 - acc: 0.4707 - val_loss: 8.8718 - val_acc: 0.3916
    Epoch 10/20
    6560/6680 [============================>.] - ETA: 0s - loss: 8.1394 - acc: 0.4744Epoch 00009: val_loss improved from 8.87180 to 8.63813, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 8.1309 - acc: 0.4744 - val_loss: 8.6381 - val_acc: 0.3976
    Epoch 11/20
    6540/6680 [============================>.] - ETA: 0s - loss: 7.9307 - acc: 0.4911 Epoch 00010: val_loss improved from 8.63813 to 8.54287, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 7.9316 - acc: 0.4912 - val_loss: 8.5429 - val_acc: 0.4096
    Epoch 12/20
    6660/6680 [============================>.] - ETA: 0s - loss: 7.8660 - acc: 0.4988Epoch 00011: val_loss improved from 8.54287 to 8.41362, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 7.8739 - acc: 0.4984 - val_loss: 8.4136 - val_acc: 0.4180
    Epoch 13/20
    6620/6680 [============================>.] - ETA: 0s - loss: 7.8398 - acc: 0.5030Epoch 00012: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 7.8450 - acc: 0.5027 - val_loss: 8.4217 - val_acc: 0.4168
    Epoch 14/20
    6640/6680 [============================>.] - ETA: 0s - loss: 7.7117 - acc: 0.5039Epoch 00013: val_loss improved from 8.41362 to 8.26978, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 7.7143 - acc: 0.5036 - val_loss: 8.2698 - val_acc: 0.4251
    Epoch 15/20
    6640/6680 [============================>.] - ETA: 0s - loss: 7.5772 - acc: 0.5133Epoch 00014: val_loss improved from 8.26978 to 8.24924, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 7.5737 - acc: 0.5133 - val_loss: 8.2492 - val_acc: 0.4240
    Epoch 16/20
    6620/6680 [============================>.] - ETA: 0s - loss: 7.5286 - acc: 0.5196Epoch 00015: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 7.5382 - acc: 0.5192 - val_loss: 8.2677 - val_acc: 0.4216
    Epoch 17/20
    6600/6680 [============================>.] - ETA: 0s - loss: 7.4822 - acc: 0.5241Epoch 00016: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 7.4887 - acc: 0.5238 - val_loss: 8.3043 - val_acc: 0.4120
    Epoch 18/20
    6620/6680 [============================>.] - ETA: 0s - loss: 7.3578 - acc: 0.5316Epoch 00017: val_loss improved from 8.24924 to 8.17803, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 7.3694 - acc: 0.5308 - val_loss: 8.1780 - val_acc: 0.4251
    Epoch 19/20
    6600/6680 [============================>.] - ETA: 0s - loss: 7.3338 - acc: 0.5329Epoch 00018: val_loss improved from 8.17803 to 8.07120, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 2s - loss: 7.3186 - acc: 0.5338 - val_loss: 8.0712 - val_acc: 0.4431
    Epoch 20/20
    6640/6680 [============================>.] - ETA: 0s - loss: 7.1936 - acc: 0.5411Epoch 00019: val_loss improved from 8.07120 to 7.99900, saving model to saved_models/weights.best.VGG16.hdf5
    6680/6680 [==============================] - 3s - loss: 7.2002 - acc: 0.5406 - val_loss: 7.9990 - val_acc: 0.4335
    


```python
plot_loss(VGG16plot)
```


![png](output_45_0.png)


### Load the Model with the Best Validation Loss


```python
VGG16_model.load_weights('saved_models/weights.best.VGG16.hdf5')
```

### Test the Model

Now, we can use the CNN to test how well it identifies breed within our test dataset of dog images.  We print the test accuracy below.


```python
# get index of predicted dog breed for each image in test set
VGG16_predictions = [np.argmax(VGG16_model.predict(np.expand_dims(feature, axis=0))) for feature in test_VGG16]

# report test accuracy
test_accuracy = 100*np.sum(np.array(VGG16_predictions)==np.argmax(test_targets, axis=1))/len(VGG16_predictions)
print('Test accuracy: %.4f%%' % test_accuracy)
```

    Test accuracy: 44.6172%
    

### Predict Dog Breed with the Model


```python
from extract_bottleneck_features import *

def VGG16_predict_breed(img_path):
    # extract bottleneck features
    bottleneck_feature = extract_VGG16(path_to_tensor(img_path))
    # obtain predicted vector
    predicted_vector = VGG16_model.predict(bottleneck_feature)
    # return dog breed that is predicted by the model
    return dog_names[np.argmax(predicted_vector)]
```

---
<a id='step5'></a>
## Step 5: Create a CNN to Classify Dog Breeds (using Transfer Learning)

You will now use transfer learning to create a CNN that can identify dog breed from images.  Your CNN must attain at least 60% accuracy on the test set.

In Step 4, we used transfer learning to create a CNN using VGG-16 bottleneck features.  In this section, you must use the bottleneck features from a different pre-trained model.  To make things easier for you, we have pre-computed the features for all of the networks that are currently available in Keras:
- [VGG-19](https://s3-us-west-1.amazonaws.com/udacity-aind/dog-project/DogVGG19Data.npz) bottleneck features
- [ResNet-50](https://s3-us-west-1.amazonaws.com/udacity-aind/dog-project/DogResnet50Data.npz) bottleneck features
- [Inception](https://s3-us-west-1.amazonaws.com/udacity-aind/dog-project/DogInceptionV3Data.npz) bottleneck features
- [Xception](https://s3-us-west-1.amazonaws.com/udacity-aind/dog-project/DogXceptionData.npz) bottleneck features

The files are encoded as such:

    Dog{network}Data.npz
    
where `{network}`, in the above filename, can be one of `VGG19`, `Resnet50`, `InceptionV3`, or `Xception`.  Pick one of the above architectures, download the corresponding bottleneck features, and store the downloaded file in the `bottleneck_features/` folder in the repository.

### (IMPLEMENTATION) Obtain Bottleneck Features

In the code block below, extract the bottleneck features corresponding to the train, test, and validation sets by running the following:

    bottleneck_features = np.load('bottleneck_features/Dog{network}Data.npz')
    train_{network} = bottleneck_features['train']
    valid_{network} = bottleneck_features['valid']
    test_{network} = bottleneck_features['test']


```python
### TODO: Obtain bottleneck features from another pre-trained CNN.

bottleneck_features = np.load('bottleneck_features/DogResnet50Data.npz')
train_ResNet50 = bottleneck_features['train']
valid_ResNet50 = bottleneck_features['valid']
test_ResNet50 = bottleneck_features['test']
```

### (IMPLEMENTATION) Model Architecture

Create a CNN to classify dog breed.  At the end of your code cell block, summarize the layers of your model by executing the line:
    
        <your model's name>.summary()
   
__Question 5:__ Outline the steps you took to get to your final CNN architecture and your reasoning at each step.  Describe why you think the architecture is suitable for the current problem.

__Answer:__ 




```python
from keras.layers import GlobalMaxPooling2D
print(train_ResNet50.shape)
my_model = Sequential()
# ResNet50_model.add(GlobalMaxPooling2D(input_shape=train_ResNet50.shape[1:]))
# ResNet50_model.add(GlobalAveragePooling2D(input_shape=train_ResNet50.shape[1:]))
my_model.add(Flatten(input_shape=train_ResNet50.shape[1:]))
my_model.add(Dropout(0.5))
my_model.add(Dense(1024, activation='relu'))
my_model.add(Dropout(0.5))
my_model.add(Dense(1024, activation='relu'))
my_model.add(Dropout(0.5))
my_model.add(Dense(133, activation='softmax'))

my_model.summary()
```

    (6680, 1, 1, 2048)
    _________________________________________________________________
    Layer (type)                 Output Shape              Param #   
    =================================================================
    flatten_3 (Flatten)          (None, 2048)              0         
    _________________________________________________________________
    dropout_6 (Dropout)          (None, 2048)              0         
    _________________________________________________________________
    dense_7 (Dense)              (None, 1024)              2098176   
    _________________________________________________________________
    dropout_7 (Dropout)          (None, 1024)              0         
    _________________________________________________________________
    dense_8 (Dense)              (None, 1024)              1049600   
    _________________________________________________________________
    dropout_8 (Dropout)          (None, 1024)              0         
    _________________________________________________________________
    dense_9 (Dense)              (None, 133)               136325    
    =================================================================
    Total params: 3,284,101.0
    Trainable params: 3,284,101.0
    Non-trainable params: 0.0
    _________________________________________________________________
    

### (IMPLEMENTATION) Compile the Model


```python
from keras import optimizers
# opti = optimizers.SGD(lr=0.01, momentum=0, decay=0, nesterov=False)
# opti = optimizers.RMSprop(lr=0.001, rho=0.9, epsilon=None, decay=0.0)
# opti = optimizers.Adagrad(lr=0.01, epsilon=None, decay=0.0)
# opti = optimizers.Adadelta(lr=1.0, rho=0.95, epsilon=None, decay=0.0)
# opti = optimizers.Adam(lr=0.001, beta_1=0.9, beta_2=0.999, epsilon=None, decay=0.0, amsgrad=False)
# opti = optimizers.Adamax(lr=0.002, beta_1=0.9, beta_2=0.999, epsilon=None, decay=0.0)
# opti = optimizers.Nadam(lr=0.002, beta_1=0.9, beta_2=0.999, epsilon=None, schedule_decay=0.004)

my_model.compile(loss='categorical_crossentropy', optimizer='adadelta', metrics=['accuracy'])
```

### (IMPLEMENTATION) Train the Model

Train your model in the code cell below.  Use model checkpointing to save the model that attains the best validation loss.  

You are welcome to [augment the training data](https://blog.keras.io/building-powerful-image-classification-models-using-very-little-data.html), but this is not a requirement. 


```python
### TODO: Train the model.
from keras.callbacks import ModelCheckpoint
# from keras_tqdm import TQDMNotebookCallback
checkpointer = ModelCheckpoint(filepath='saved_models/weights.best.ResNet50.hdf5', 
                               verbose=1, save_best_only=True)

my_modelplot = my_model.fit(train_ResNet50, train_targets, 
          validation_data=(valid_ResNet50, valid_targets),
          epochs=50, batch_size=32, callbacks=[checkpointer], verbose=1)
```

    Train on 6680 samples, validate on 835 samples
    Epoch 1/50
    6560/6680 [============================>.] - ETA: 0s - loss: 4.5403 - acc: 0.0738  Epoch 00000: val_loss improved from inf to 2.94360, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 4.5257 - acc: 0.0757 - val_loss: 2.9436 - val_acc: 0.4778
    Epoch 2/50
    6560/6680 [============================>.] - ETA: 0s - loss: 2.9187 - acc: 0.2840Epoch 00001: val_loss improved from 2.94360 to 1.52006, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 2.9152 - acc: 0.2841 - val_loss: 1.5201 - val_acc: 0.6611
    Epoch 3/50
    6560/6680 [============================>.] - ETA: 0s - loss: 2.1506 - acc: 0.4262Epoch 00002: val_loss improved from 1.52006 to 1.11127, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 2.1502 - acc: 0.4265 - val_loss: 1.1113 - val_acc: 0.7078
    Epoch 4/50
    6560/6680 [============================>.] - ETA: 0s - loss: 1.7308 - acc: 0.5125Epoch 00003: val_loss improved from 1.11127 to 0.91023, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 1.7306 - acc: 0.5121 - val_loss: 0.9102 - val_acc: 0.7425
    Epoch 5/50
    6560/6680 [============================>.] - ETA: 0s - loss: 1.5010 - acc: 0.5663Epoch 00004: val_loss improved from 0.91023 to 0.79157, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 1.5003 - acc: 0.5680 - val_loss: 0.7916 - val_acc: 0.7796
    Epoch 6/50
    6560/6680 [============================>.] - ETA: 0s - loss: 1.3299 - acc: 0.6006Epoch 00005: val_loss improved from 0.79157 to 0.74724, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 1.3249 - acc: 0.6022 - val_loss: 0.7472 - val_acc: 0.7832
    Epoch 7/50
    6560/6680 [============================>.] - ETA: 0s - loss: 1.1902 - acc: 0.6415Epoch 00006: val_loss improved from 0.74724 to 0.68511, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 1.1877 - acc: 0.6424 - val_loss: 0.6851 - val_acc: 0.8060
    Epoch 8/50
    6560/6680 [============================>.] - ETA: 0s - loss: 1.1086 - acc: 0.6634Epoch 00007: val_loss improved from 0.68511 to 0.65483, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 1.1062 - acc: 0.6638 - val_loss: 0.6548 - val_acc: 0.8060
    Epoch 9/50
    6560/6680 [============================>.] - ETA: 0s - loss: 1.0383 - acc: 0.6838Epoch 00008: val_loss improved from 0.65483 to 0.64302, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 1.0407 - acc: 0.6837 - val_loss: 0.6430 - val_acc: 0.8132
    Epoch 10/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.9660 - acc: 0.7012Epoch 00009: val_loss improved from 0.64302 to 0.61629, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 0.9664 - acc: 0.7007 - val_loss: 0.6163 - val_acc: 0.8084
    Epoch 11/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.8947 - acc: 0.7203Epoch 00010: val_loss improved from 0.61629 to 0.60063, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 0.8940 - acc: 0.7202 - val_loss: 0.6006 - val_acc: 0.8108
    Epoch 12/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.8621 - acc: 0.7373Epoch 00011: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.8586 - acc: 0.7376 - val_loss: 0.6011 - val_acc: 0.8156
    Epoch 13/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.8023 - acc: 0.7538Epoch 00012: val_loss improved from 0.60063 to 0.58096, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 0.8033 - acc: 0.7539 - val_loss: 0.5810 - val_acc: 0.8263
    Epoch 14/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.7839 - acc: 0.7489Epoch 00013: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.7849 - acc: 0.7494 - val_loss: 0.5818 - val_acc: 0.8120
    Epoch 15/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.7525 - acc: 0.7645Epoch 00014: val_loss improved from 0.58096 to 0.57992, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 2s - loss: 0.7527 - acc: 0.7648 - val_loss: 0.5799 - val_acc: 0.8180
    Epoch 16/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.7277 - acc: 0.7785Epoch 00015: val_loss improved from 0.57992 to 0.56735, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 2s - loss: 0.7251 - acc: 0.7793 - val_loss: 0.5674 - val_acc: 0.8204
    Epoch 17/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.6945 - acc: 0.7828Epoch 00016: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.6948 - acc: 0.7832 - val_loss: 0.5674 - val_acc: 0.8144
    Epoch 18/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.6629 - acc: 0.7904Epoch 00017: val_loss improved from 0.56735 to 0.53940, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 3s - loss: 0.6627 - acc: 0.7906 - val_loss: 0.5394 - val_acc: 0.8275
    Epoch 19/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.6451 - acc: 0.7950Epoch 00018: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.6452 - acc: 0.7955 - val_loss: 0.5606 - val_acc: 0.8216
    Epoch 20/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.6284 - acc: 0.7973Epoch 00019: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.6267 - acc: 0.7972 - val_loss: 0.5443 - val_acc: 0.8299
    Epoch 21/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.5863 - acc: 0.8053Epoch 00020: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.5847 - acc: 0.8060 - val_loss: 0.5441 - val_acc: 0.8287
    Epoch 22/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.5763 - acc: 0.8171Epoch 00021: val_loss improved from 0.53940 to 0.52709, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 2s - loss: 0.5781 - acc: 0.8165 - val_loss: 0.5271 - val_acc: 0.8311
    Epoch 23/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.5487 - acc: 0.8241Epoch 00022: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.5480 - acc: 0.8240 - val_loss: 0.5552 - val_acc: 0.8311
    Epoch 24/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.5368 - acc: 0.8280Epoch 00023: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.5380 - acc: 0.8277 - val_loss: 0.5445 - val_acc: 0.8299
    Epoch 25/50
    6592/6680 [============================>.] - ETA: 0s - loss: 0.5302 - acc: 0.8262Epoch 00024: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.5299 - acc: 0.8263 - val_loss: 0.5543 - val_acc: 0.8275
    Epoch 26/50
    6592/6680 [============================>.] - ETA: 0s - loss: 0.5338 - acc: 0.8254Epoch 00025: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.5363 - acc: 0.8247 - val_loss: 0.5328 - val_acc: 0.8359
    Epoch 27/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.5090 - acc: 0.8354Epoch 00026: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.5113 - acc: 0.8346 - val_loss: 0.5421 - val_acc: 0.8323
    Epoch 28/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.4785 - acc: 0.8402Epoch 00027: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.4821 - acc: 0.8395 - val_loss: 0.5313 - val_acc: 0.8371
    Epoch 29/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.4637 - acc: 0.8483Epoch 00028: val_loss improved from 0.52709 to 0.52608, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 2s - loss: 0.4626 - acc: 0.8485 - val_loss: 0.5261 - val_acc: 0.8431
    Epoch 30/50
    6624/6680 [============================>.] - ETA: 0s - loss: 0.4663 - acc: 0.8530Epoch 00029: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.4672 - acc: 0.8525 - val_loss: 0.5403 - val_acc: 0.8395
    Epoch 31/50
    6592/6680 [============================>.] - ETA: 0s - loss: 0.4355 - acc: 0.8565Epoch 00030: val_loss improved from 0.52608 to 0.52445, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 2s - loss: 0.4350 - acc: 0.8564 - val_loss: 0.5245 - val_acc: 0.8419
    Epoch 32/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.4449 - acc: 0.8558Epoch 00031: val_loss improved from 0.52445 to 0.51965, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 2s - loss: 0.4435 - acc: 0.8563 - val_loss: 0.5196 - val_acc: 0.8443
    Epoch 33/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.4223 - acc: 0.8608Epoch 00032: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.4218 - acc: 0.8615 - val_loss: 0.5243 - val_acc: 0.8527
    Epoch 34/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.4081 - acc: 0.8701Epoch 00033: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.4098 - acc: 0.8696 - val_loss: 0.5272 - val_acc: 0.8335
    Epoch 35/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.4089 - acc: 0.8668Epoch 00034: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.4080 - acc: 0.8668 - val_loss: 0.5448 - val_acc: 0.8431
    Epoch 36/50
    6624/6680 [============================>.] - ETA: 0s - loss: 0.3965 - acc: 0.8709Epoch 00035: val_loss improved from 0.51965 to 0.51944, saving model to saved_models/weights.best.ResNet50.hdf5
    6680/6680 [==============================] - 2s - loss: 0.3961 - acc: 0.8707 - val_loss: 0.5194 - val_acc: 0.8431
    Epoch 37/50
    6592/6680 [============================>.] - ETA: 0s - loss: 0.3776 - acc: 0.8736Epoch 00036: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.3775 - acc: 0.8737 - val_loss: 0.5275 - val_acc: 0.8443
    Epoch 38/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.3829 - acc: 0.8777Epoch 00037: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.3804 - acc: 0.8783 - val_loss: 0.5217 - val_acc: 0.8563
    Epoch 39/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.3740 - acc: 0.8806Epoch 00038: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.3767 - acc: 0.8802 - val_loss: 0.5425 - val_acc: 0.8359
    Epoch 40/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.3772 - acc: 0.8787Epoch 00039: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.3747 - acc: 0.8792 - val_loss: 0.5202 - val_acc: 0.8419
    Epoch 41/50
    6592/6680 [============================>.] - ETA: 0s - loss: 0.3557 - acc: 0.8796Epoch 00040: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.3555 - acc: 0.8796 - val_loss: 0.5380 - val_acc: 0.8467
    Epoch 42/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.3640 - acc: 0.8805Epoch 00041: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.3661 - acc: 0.8802 - val_loss: 0.5469 - val_acc: 0.8419
    Epoch 43/50
    6592/6680 [============================>.] - ETA: 0s - loss: 0.3623 - acc: 0.8826Epoch 00042: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.3618 - acc: 0.8826 - val_loss: 0.5283 - val_acc: 0.8455
    Epoch 44/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.3181 - acc: 0.8974Epoch 00043: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.3170 - acc: 0.8976 - val_loss: 0.5479 - val_acc: 0.8467
    Epoch 45/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.3421 - acc: 0.8892Epoch 00044: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.3422 - acc: 0.8886 - val_loss: 0.5337 - val_acc: 0.8503
    Epoch 46/50
    6592/6680 [============================>.] - ETA: 0s - loss: 0.3181 - acc: 0.8968Epoch 00045: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.3207 - acc: 0.8966 - val_loss: 0.5596 - val_acc: 0.8371
    Epoch 47/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.3059 - acc: 0.8989Epoch 00046: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.3058 - acc: 0.8988 - val_loss: 0.5497 - val_acc: 0.8467
    Epoch 48/50
    6592/6680 [============================>.] - ETA: 0s - loss: 0.3110 - acc: 0.8967Epoch 00047: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.3126 - acc: 0.8958 - val_loss: 0.5496 - val_acc: 0.8407
    Epoch 49/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.2887 - acc: 0.9062Epoch 00048: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.2908 - acc: 0.9057 - val_loss: 0.5700 - val_acc: 0.8347
    Epoch 50/50
    6560/6680 [============================>.] - ETA: 0s - loss: 0.3013 - acc: 0.9009Epoch 00049: val_loss did not improve
    6680/6680 [==============================] - 2s - loss: 0.3069 - acc: 0.9001 - val_loss: 0.5518 - val_acc: 0.8467
    


```python
plot_loss(my_modelplot)
```


![png](output_60_0.png)


### (IMPLEMENTATION) Load the Model with the Best Validation Loss


```python
### TODO: Load the model weights with the best validation loss.
my_model.load_weights('saved_models/weights.best.ResNet50.hdf5')
```

### (IMPLEMENTATION) Test the Model

Try out your model on the test dataset of dog images. Ensure that your test accuracy is greater than 60%.


```python
### TODO: Calculate classification accuracy on the test dataset.
ResNet50_predictions = [np.argmax(my_model.predict(np.expand_dims(feature, axis=0))) for feature in test_ResNet50]

# report test accuracy
test_accuracy = 100*np.sum(np.array(ResNet50_predictions)==np.argmax(test_targets, axis=1))/len(ResNet50_predictions)
print('Test accuracy: %.4f%%' % test_accuracy)
```

    Test accuracy: 83.7321%
    

### (IMPLEMENTATION) Predict Dog Breed with the Model

Write a function that takes an image path as input and returns the dog breed (`Affenpinscher`, `Afghan_hound`, etc) that is predicted by your model.  

Similar to the analogous function in Step 5, your function should have three steps:
1. Extract the bottleneck features corresponding to the chosen CNN model.
2. Supply the bottleneck features as input to the model to return the predicted vector.  Note that the argmax of this prediction vector gives the index of the predicted dog breed.
3. Use the `dog_names` array defined in Step 0 of this notebook to return the corresponding breed.

The functions to extract the bottleneck features can be found in `extract_bottleneck_features.py`, and they have been imported in an earlier code cell.  To obtain the bottleneck features corresponding to your chosen CNN architecture, you need to use the function

    extract_{network}
    
where `{network}`, in the above filename, should be one of `VGG19`, `Resnet50`, `InceptionV3`, or `Xception`.


```python
### TODO: Write a function that takes a path to an image as input
### and returns the dog breed that is predicted by the model.

from extract_bottleneck_features import *

def ResNet50_predict_breed(img_path):
    # extract bottleneck features
    bottleneck_feature = extract_Resnet50(path_to_tensor(img_path))
    # obtain predicted vector
    predicted_vector = my_model.predict(bottleneck_feature)
    # return dog breed that is predicted by the model
    return dog_names[np.argmax(predicted_vector)]
```

---
<a id='step6'></a>
## Step 6: Write your Algorithm

Write an algorithm that accepts a file path to an image and first determines whether the image contains a human, dog, or neither.  Then,
- if a __dog__ is detected in the image, return the predicted breed.
- if a __human__ is detected in the image, return the resembling dog breed.
- if __neither__ is detected in the image, provide output that indicates an error.

You are welcome to write your own functions for detecting humans and dogs in images, but feel free to use the `face_detector` and `dog_detector` functions developed above.  You are __required__ to use your CNN from Step 5 to predict dog breed.  

Some sample output for our algorithm is provided below, but feel free to design your own user experience!

![Sample Human Output](images/sample_human_output.png)


### (IMPLEMENTATION) Write your Algorithm


```python
### TODO: Write your algorithm.
### Feel free to use as many code cells as needed.

def plt_img(path):
    img = cv2.imread(path)
    cv_rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
    plt.imshow(cv_rgb)
    plt.show()

def mypredict(img):
    if dog_detector(img):
        print('This image is a dog!')
        plt_img(img)
        print('The dog breed is: {}'.format(ResNet50_predict_breed(img)))
    elif face_detector(img):
        print('This image is a human!')
        plt_img(img)
        print('The dog breed that most resembles that face is: {}'.format(ResNet50_predict_breed(img)))
    else:
        print('This image is neither a dog or a human!')
        plt_img(img)

```

---
<a id='step7'></a>
## Step 7: Test Your Algorithm

In this section, you will take your new algorithm for a spin!  What kind of dog does the algorithm think that __you__ look like?  If you have a dog, does it predict your dog's breed accurately?  If you have a cat, does it mistakenly think that your cat is a dog?

### (IMPLEMENTATION) Test Your Algorithm on Sample Images!

Test your algorithm at least six images on your computer.  Feel free to use any images you like.  Use at least two human and two dog images.  

__Question 6:__ Is the output better than you expected :) ?  Or worse :( ?  Provide at least three possible points of improvement for your algorithm.

__Answer:__ 


```python
## TODO: Execute your algorithm from Step 6 on
## at least 6 images on your computer.
## Feel free to use as many code cells as needed.
img = []
img.append('test_images/dog_1.jpg')
img.append('test_images/dog_2.jpg')
img.append('test_images/face_1.jpg')
img.append('test_images/face_2.jpg')
img.append('test_images/face_3.png')
img.append('test_images/cat_1.jpg')
img.append('test_images/horse_1.jpg')

for i in range(len(img)):
    mypredict(img[i])
# mypredict(img[0])
```

    This image is a dog!
    


![png](output_70_1.png)


    The dog breed is: Smooth_fox_terrier
    This image is a dog!
    


![png](output_70_3.png)


    The dog breed is: English_setter
    This image is a human!
    


![png](output_70_5.png)


    The dog breed that most resembles that face is: Brussels_griffon
    This image is a human!
    


![png](output_70_7.png)


    The dog breed that most resembles that face is: English_toy_spaniel
    This image is a human!
    


![png](output_70_9.png)


    The dog breed that most resembles that face is: Dogue_de_bordeaux
    This image is neither a dog or a human!
    


![png](output_70_11.png)


    This image is neither a dog or a human!
    


![png](output_70_13.png)



```python
mypredict('test_images/henry.jpeg')
```

    This image is a human!
    


![png](output_71_1.png)


    The dog breed that most resembles that face is: English_toy_spaniel
    


```python
mypredict('test_images/dana.jpeg')
```

    This image is a human!
    


![png](output_72_1.png)


    The dog breed that most resembles that face is: English_toy_spaniel
    


```python
mypredict('test_images/ben.jpg')
```

    This image is a human!
    


![png](output_73_1.png)


    The dog breed that most resembles that face is: Ibizan_hound
    


```python

```
